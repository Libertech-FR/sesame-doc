import{_ as n,c as e,o as s,a}from"./app-IsPPEY10.js";const i={},l=a(`<h1 id="introduction" tabindex="-1"><a class="header-anchor" href="#introduction"><span>Introduction</span></a></h1><p>Les backends seront exécutés par <strong>sesame-daemon</strong> sur requete de sesame orchestrateur</p><h3 id="workflow" tabindex="-1"><a class="header-anchor" href="#workflow"><span>Workflow</span></a></h3><ul><li>Une identité est passée au statut A SYNCHRONISER</li><li>Une action sur le bouton de lancement de la synchronisation va effectuer un déclenchement des backends</li><li>les Backends vont être executés dans l&#39;ordre où il ont été mis dans le repertoire backends (<em>var/lib/sesame-daemon/backend</em>)</li><li>Le daemon enverra le resultat de l&#39;execution à l&#39;orchestrator</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre class="language-text"><code><span class="line">UI ---&gt; API &lt;--&gt; Daemon &lt;---&gt; Backends </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h1 id="fonctionnement-d-un-backend" tabindex="-1"><a class="header-anchor" href="#fonctionnement-d-un-backend"><span>Fonctionnement d&#39;un backend</span></a></h1><p>Un backend peut être écrit dans n&#39;importe quel language, du moment que celui-ci sait gérer les entrées et sorties standard.</p><h2 id="comunication-avec-le-daemon" tabindex="-1"><a class="header-anchor" href="#comunication-avec-le-daemon"><span>Comunication avec le daemon</span></a></h2><p>Le daemon enverra sur l&#39;entrée standard du backend au format JSON l&#39;identité concernée :</p><p>Exemple :</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre class="language-text"><code><span class="line">{</span>
<span class="line">  &quot;concernedTo&quot;: &quot;66c22991bdc3c9a7563a9d4f&quot;,</span>
<span class="line">  &quot;payload&quot;: {</span>
<span class="line">    &quot;identity&quot;: {</span>
<span class="line">      &quot;action&quot;: &quot;IDENTITY_UPDATE&quot;,</span>
<span class="line">      &quot;identity&quot;: {</span>
<span class="line">        &quot;_id&quot;: &quot;66c22991bdc3c9a7563a9d4f&quot;,</span>
<span class="line">        &quot;metadata&quot;: {</span>
<span class="line">          &quot;createdBy&quot;: &quot;admin&quot;,</span>
<span class="line">          &quot;createdAt&quot;: &quot;2024-08-18T17:04:17.757Z&quot;,</span>
<span class="line">          &quot;lastUpdatedBy&quot;: &quot;admin&quot;,</span>
<span class="line">          &quot;lastUpdatedAt&quot;: &quot;2024-08-20T09:45:57.596Z&quot;</span>
<span class="line">        },</span>
<span class="line">        &quot;state&quot;: 2,</span>
<span class="line">        &quot;lifecycle&quot;: -1,</span>
<span class="line">        &quot;inetOrgPerson&quot;: {</span>
<span class="line">          &quot;cn&quot;: &quot;DUPONT Alain&quot;,</span>
<span class="line">          &quot;displayName&quot;: &quot;Alain Dupont&quot;,</span>
<span class="line">          &quot;facsimileTelephoneNumber&quot;: &quot;&quot;,</span>
<span class="line">          &quot;givenName&quot;: &quot;Alain&quot;,</span>
<span class="line">          &quot;labeledURI&quot;: &quot;&quot;,</span>
<span class="line">          &quot;mail&quot;: &quot;ad@lmondomaine.com&quot;,</span>
<span class="line">          &quot;mobile&quot;: &quot;06 07 08 09 10&quot;,</span>
<span class="line">          &quot;postalAddress&quot;: &quot;&quot;,</span>
<span class="line">          &quot;preferredLanguage&quot;: &quot;&quot;,</span>
<span class="line">          &quot;sn&quot;: &quot;DUPONT&quot;,</span>
<span class="line">          &quot;telephoneNumber&quot;: &quot;&quot;,</span>
<span class="line">          &quot;title&quot;: &quot;&quot;,</span>
<span class="line">          &quot;uid&quot;: &quot;aabbas&quot;,</span>
<span class="line">          &quot;employeeNumber&quot;: &quot;111111&quot;,</span>
<span class="line">          &quot;employeeType&quot;: &quot;TAIGA&quot;,</span>
<span class="line">          &quot;departmentNumber&quot;: &quot;&quot;,</span>
<span class="line">          &quot;jpegPhoto&quot;: &quot;&quot;,</span>
<span class="line">          &quot;userCertificate&quot;: &quot;&quot;,</span>
<span class="line">          &quot;userPassword&quot;: &quot;&quot;</span>
<span class="line">        },</span>
<span class="line">        &quot;additionalFields&quot;: {</span>
<span class="line">          &quot;objectClasses&quot;: [</span>
<span class="line">            &quot;supannPerson&quot;</span>
<span class="line">          ],</span>
<span class="line">          &quot;attributes&quot;: {</span>
<span class="line">            &quot;supannPerson&quot;: {</span>
<span class="line">              &quot;supanncivilite&quot;: &quot;M.&quot;,</span>
<span class="line">              &quot;supannOIDCGenre&quot;: &quot;M.&quot;,</span>
<span class="line">              &quot;supannPrenomsEtatCivil&quot;: &quot;Alain&quot;,</span>
<span class="line">              &quot;supannAutreMail&quot;: &quot;ad@monmailpriver.com&quot;,</span>
<span class="line">              &quot;supannNomdeNaissance&quot;: &quot;&quot;,</span>
<span class="line">              &quot;supannOIDCDatedeNaissance&quot;: &quot;&quot;,</span>
<span class="line">              &quot;supannCodeINSEEPaysDeNaissance&quot;: &quot;&quot;,</span>
<span class="line">              &quot;supannCodeINSEEVilleDeNaissance&quot;: &quot;&quot;,</span>
<span class="line">              &quot;supannListeRouge&quot;: &quot;&quot;,</span>
<span class="line">              &quot;mailForwardingAddress&quot;: &quot;&quot;,</span>
<span class="line">              &quot;supannMailPerso&quot;: &quot;&quot;,</span>
<span class="line">              &quot;supannRoleGenerique&quot;: &quot;&quot;,</span>
<span class="line">              &quot;supannEmpId&quot;: 0,</span>
<span class="line">              &quot;supannParrainDN&quot;: &quot;&quot;,</span>
<span class="line">              &quot;supannTypeEntiteAffectation&quot;: &quot;&quot;,</span>
<span class="line">              &quot;supannActivite&quot;: &quot;&quot;,</span>
<span class="line">              &quot;supannEmpDateFin&quot;: &quot;&quot;,</span>
<span class="line">              &quot;supannEtablissement&quot;: &quot;&quot;</span>
<span class="line">            }</span>
<span class="line">          }</span>
<span class="line">        },</span>
<span class="line">        &quot;initState&quot;: 0,</span>
<span class="line">        &quot;fingerprint&quot;: &quot;b65c62b466b0c401398c9da3ca489a880befc38f049e6dfacb48eded011eff11&quot;</span>
<span class="line">      }</span>
<span class="line">    }</span>
<span class="line">  }</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Le backend traitera la demande et renverra sur sa sortie standard le resultat au format JSON avec 2 clés :</p><ul><li>status : 0 OK autre que 0 probleme</li><li>message : le message pour le journal de sesame</li></ul><p>Exemple :</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre class="language-text"><code><span class="line">{&quot;status&quot;: 0, &quot;message&quot;: &quot;server alive&quot;}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="structure-d-un-backend" tabindex="-1"><a class="header-anchor" href="#structure-d-un-backend"><span>Structure d&#39;un backend</span></a></h2><p>chaque backend a un espace dans <strong>/var/lib/sesame-daemon/backend</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre class="language-text"><code><span class="line">XXmonbackend </span>
<span class="line">	config.yml</span>
<span class="line">	bin</span>
<span class="line">	   script1</span>
<span class="line">	   script2</span>
<span class="line">	   ...</span>
<span class="line">	</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Ceci est la structure minimum. Le daemon excutera le script concerné en se deplaçant dans <strong>bin</strong></p><p>Vous pouvez ajouter dans cette arborescense ce que vous avez besoin (etc, lib ...)</p><h3 id="fichier-config-yml" tabindex="-1"><a class="header-anchor" href="#fichier-config-yml"><span>Fichier config.yml</span></a></h3><p>Ce fichier renseigne le daemon du script à executer selon l&#39;action demandée. Le script doit avoir le droit d&#39;execution.</p><p>Ce fichier se compose d&#39;une entete et des actions :</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre class="language-text"><code><span class="line">_version: 1</span>
<span class="line"></span>
<span class="line">name: &#39;dummy&#39;</span>
<span class="line">description: &#39;Dummy backend for tests&#39;</span>
<span class="line">active: true</span>
<span class="line">actions:</span>
<span class="line">  IDENTITY_PASSWORD_CHANGE:</span>
<span class="line">    script: &quot;dummy.sh&quot;</span>
<span class="line">    onError: &#39;stop&#39;</span>
<span class="line">  IDENTITY_PASSWORD_RESET:</span>
<span class="line">    script: &quot;dummy.sh&quot;</span>
<span class="line">    onError: &#39;stop&#39;</span>
<span class="line">  IDENTITY_CREATE:</span>
<span class="line">    script: &#39;dummy.sh&#39;</span>
<span class="line">    onError: &#39;stop&#39;</span>
<span class="line">  IDENTITY_UPDATE:</span>
<span class="line">    script: &#39;dummy.sh&#39;</span>
<span class="line">    onError: &#39;stop&#39;</span>
<span class="line">  IDENTITY_DELETE:</span>
<span class="line">    script: &#39;dummy.sh&#39;</span>
<span class="line">    onError: &#39;stop&#39;</span>
<span class="line">  PING_TARGET:</span>
<span class="line">    script: &#39;dummy.sh&#39;</span>
<span class="line">    onError: &#39;continue&#39;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="les-actions" tabindex="-1"><a class="header-anchor" href="#les-actions"><span>Les actions :</span></a></h3><ul><li><strong>IDENTITY_PASSWORD_CHANGE</strong> : est appellé lors du changement du mot de passe.</li><li><strong>IDENTITY_PASSWORD_RESET</strong> : est appellé pour un RESET du mot de passe.</li><li><strong>IDENTITY_CREATE</strong> : Non utilisé pour l instant</li><li><strong>IDENTITY_UPDATE</strong> : Appelé lors de la creation ou modification d&#39;une identité</li><li><strong>IDENTITY_DELETE</strong> : Appelé lors de la suppression d&#39;une identité</li><li><strong>IDENTITY_ENABLE</strong> : Appelé lors de l&#39;activation d&#39;une identité</li><li><strong>IDENTITY_DISABLE</strong> : Appelé lors de desactivation d&#39;une identité</li><li><strong>PING_TARGET</strong> : appellé pour la verification du backend</li></ul><p>Paramètres :</p><ul><li><strong>script</strong> : Nom du script (dans bin) qui doit être appellé sur l&#39;action concernée</li><li><strong>onError</strong> : continue | stop Permet d&#39;indiquer en cas d&#39;erreur si le daemon doit continuer ou abandonner</li></ul><h2 id="exemple-de-script-bash" tabindex="-1"><a class="header-anchor" href="#exemple-de-script-bash"><span>Exemple de script bash :</span></a></h2><p>Cet exemple écrit juste le contenu du json reçu sur l&#39;entrée standard dans un fichier :</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre class="language-text"><code><span class="line">#!/bin/sh</span>
<span class="line">JSON=\`cat -\`</span>
<span class="line">sleep 1</span>
<span class="line">echo $JSON &gt;/tmp/dummy.json</span>
<span class="line">echo &quot;{\\&quot;status\\&quot;: 0, \\&quot;message\\&quot;: \\&quot;dummy upsertbackend backend\\&quot;}&quot;</span>
<span class="line">exit 0</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="exemple-de-backend-00dummy" tabindex="-1"><a class="header-anchor" href="#exemple-de-backend-00dummy"><span>Exemple de backend 00dummy</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre class="language-text"><code><span class="line">00dummy</span>
<span class="line">.</span>
<span class="line">./bin</span>
<span class="line">./bin/dummy.sh</span>
<span class="line">./config.yml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="debuggage-d-un-backend" tabindex="-1"><a class="header-anchor" href="#debuggage-d-un-backend"><span>Debuggage d&#39;un backend</span></a></h1><p>Il est conseillé de mettre me un backend dummy (voir l exemple) pour avoir l&#39;entrée json. Dans l exemple il creera un fichier /tmp/dummy.json pour l&#39;insertion et la modification</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre class="language-text"><code><span class="line">cd /var/lib/sesame-daemon/backends/01xx/bin</span>
<span class="line">cat /tmp/dummy.json|./upsertidentity.py</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div>`,36),t=[l];function d(u,c){return s(),e("div",null,t)}const r=n(i,[["render",d],["__file","backends.html.vue"]]),p=JSON.parse(`{"path":"/backends/backends.html","title":"Introduction","lang":"en-US","frontmatter":{},"headers":[{"level":3,"title":"Workflow","slug":"workflow","link":"#workflow","children":[]},{"level":2,"title":"Comunication avec le daemon","slug":"comunication-avec-le-daemon","link":"#comunication-avec-le-daemon","children":[]},{"level":2,"title":"Structure d'un backend","slug":"structure-d-un-backend","link":"#structure-d-un-backend","children":[{"level":3,"title":"Fichier config.yml","slug":"fichier-config-yml","link":"#fichier-config-yml","children":[]},{"level":3,"title":"Les actions :","slug":"les-actions","link":"#les-actions","children":[]}]},{"level":2,"title":"Exemple de script bash :","slug":"exemple-de-script-bash","link":"#exemple-de-script-bash","children":[]},{"level":2,"title":"Exemple de backend 00dummy","slug":"exemple-de-backend-00dummy","link":"#exemple-de-backend-00dummy","children":[]}],"git":{"updatedTime":1731145090000,"contributors":[{"name":"Alain Abbas","email":"alain.abbas@libertech.fr","commits":3}]},"filePathRelative":"backends/backends.md"}`);export{r as comp,p as data};
